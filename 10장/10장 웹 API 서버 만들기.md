9 장 NodeBird 서비스의 API 서버를 만듦

* API: Application Programming Interface
  * 다른 애플리케이션에서 현재 프로그램의 기능을 사용할 수 있게 함
* 웹 API: 다른 웹 서비스의 기능을 사용하거나 자원을 가져올 수 있게 함
  * 다른 사람에게 정보를 제공하고 싶은 부분만 API를 열고, 제공하고 싶지 않은 부분은 API를 만들지 않으면 됨
  * API에 제한을 걸어 일정 횟수 내에서만 가져가게 할 수도 있음
  * NodeBird에서는 인증된 사용자에게만 정보 제공


# API 서버에서 도메인을 등록하는 이유

* 도메인을 등록하는 이유는 등록한 도메인에서만 API를 사용할 수 있게 하기 위해서이다.
* 웹 브라우저에서 요청을 보낼 때 응답을 하는 곳과 도메인이 다르면 `CORS 에러`가 발생할 수 있따.
  * 현재 웹 사이트에서 함부로 다른 서버에 접근하는 것을 막는 조치하기 때문
* 서버에서 서버로 요청을 보내는 경우에는 CORS 문제가 발생하지 않는다.


# 10.3 JWT 토큰 인증

* NodeBird가 아닌 다른 클라이언트가 데이터를 가져가게 하려면 인증 과정이 필요함
* JWT(JSON Web Token)을 사용함  
* 헤더.페이로드.시그니처로 구성됨
  * 헤더: 토큰 종류와 해시 알고리즘 정보가 들어있음

  * 페이로드: 토큰의 내용물이 인코딩된 부분

  * 시그니처: 일련의 문자열로, 시그니처를 통해 토큰이 변조되었는지 여부 확인

  * 시그니처는 JWT 비밀키로 만들어지고, 비밀키가 노출되면 토큰 위조 가능

* jwt.io 사이트에서 내용을 쉽게 확인할 수 있다.


* JWT 모듈 설치
  * npm i jsonwebtoken
  * JWT 비밀키 .env에 저장

  * JWT 토큰을 검사하는 verifyToken 미들웨어 작성
  * jwt.verify 메서드로 검사 가능(두 번째 인수가 JWT 비밀키)
  * JWT 토큰은 req.headers.authorization에 들어 있음
  * 만료된 JWT 토큰인 경우 419 에러 발생
  * 유효하지 않은 토큰인 경우 401에러 발생
  * req.decoded에 페이로드를 넣어 다음 미들웨어에서 쓸 수 있게 함

## jwt 토큰 발급 라우터 만들기

* routes/v1.js 작성
  * 버전 1이라는 뜻의 v1.js

  * 한 번 버전이 정해진 후에는 라우터를 함부로 수정하면 안 됨

  * 다른 사람이 기존 API를 쓰고 있기 때문(그 사람에게 영향이 감)

  * 수정 사항이 생기면 버전을 올려야 함

  * POST /token에서 JWT 토큰 발급

  * 먼저 도메인 검사 후 등록된 도메인이면 jwt.sign 메서드로 JWT 토큰 발급

  * 첫 번째 인수로 페이로드를 넣고, 두 번째 인수는 JWT 비밀키, 세 번째 인수로 토큰 옵션(expiresIn은 만료 시간, issuer은 발급자)

  * expiresIn은 1m(1분), 60 * 1000같은 밀리초 단위도 가능
  
  * GET /test 라우터에서 토큰 인증 테스트 가능
  
  * 라우터의 응답은 일정한 형식으로 해야 사용자들이 헷갈리지 않음

